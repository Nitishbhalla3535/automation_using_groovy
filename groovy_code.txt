job("groovy-job1") {
     description("To pull  the github repo on every push and update the  container")


     scm {
          github('Nitishbhalla3535/Docker-and-kubernetes', 'master')
        }
    
    triggers {
           githubPush()
         }
    wrappers {
         preBuildCleanup()
      }
   


   steps {
      dockerBuildAndPublish {
        repositoryName('nitish4421/app')
        tag("latest")
        dockerHostURI('tcp://0.0.0.0:4243')
        registryCredentials('docker-hub')
        createFingerprints(false)
        skipDecorate(false)
        skipTagAsLatest(false)
          }
       }
   

 } 
 
job("groovy-job-2"){
    description("This will  run on slave nodes and control K8s.")
    triggers {
        upstream('groovy-job1', 'SUCCESS')
    }


  command = """
if sudo kubectl get deployment |grep nitishpods
then 
echo "Deployment exsists"
sudo kubectl rollout restart deploy/nitishpods
sudo kubectl rollout status deploy/nitishpods
else
sudo kubectl create deploy nitishpods --image=nitish4421/app
sudo kubectl expose deploy nitishpods --port=80  --type=NodePort
sudo kubectl scale deployment nitishpods --replicas=4
sudo kubectl get all
fi 
"""


  steps {
       shell(command)
    }
}    
 
job("groovy-job3") {
    description("for testing if pod is running or not else send the mail")


    triggers {
          upstream('groovy-job2', 'SUCCESS')
       }
    steps {
        shell('''if sudo kubectl get deployments nitishpods
 then
 echo "send to the next department"
 else
 echo "sending back to developer"
 exit 1
 fi''' )
   }
   publishers{
        extendedEmail{
            contentType('text/html')
           triggers {
             success{
                 attachBuildLog(true)
                 subject('Build successful')
                 content('The build was successful and deployment was done')
                 recipientList('nitish.bhallaf5@gmail.com')
               }
               failure{
                  attachBuildLog(true)
                  subject('Failed  build')
                  content('The build failed')
                  recipientList('nitish.bhallat32@gmail.com')
                }
              }
           }
        }
   }
